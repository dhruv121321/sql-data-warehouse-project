/*
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

this script creates a stored procedure which performs
ETL( etract -> transform -> load) on the data present
in the bronze layer schema. it cleans the data and
then stores it in silver layer tables.

The store procedure does not take any 
parameters and does not return any value
usage: EXEC silver.load_silver
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

CREATE OR ALTER PROCEDURE silver.load_silver as
BEGIN
BEGIN TRY
declare @start_time datetime;
declare @end_time datetime;
TRUNCATE TABLE silver.crm_cust_info;
 SET @start_time =getdate();
PRINT '>> inserting data into silver.crm_cust_info';
insert into silver.crm_cust_info(
cst_id, 
cst_key,
cst_firstname,
cst_lastname,
cst_marital_status,
cst_gndr
,cst_create_date
)
select cst_id, cst_key,

trim(cst_firstname) as cst_firstname ,
trim(cst_lastname) cst_lastname,

case when 
upper(TRIM(cst_marital_status)) ='M' then 'Married'
when
upper(TRIM(cst_marital_status))='S' then 'Single'
else 'Unknown' 
end cst_marital_status

,case when 
upper(TRIM(cst_gndr)) ='F' then 'Female'
when
upper(TRIM(cst_gndr))='M' then 'Male'
else 'Unknown'
end cst_gndr
, cst_create_date
from
(
select * , 
row_number()
over(partition by cst_id order by cst_create_date DESC) flag 
from bronze.crm_cust_info 
where cst_id is not null
)t
where flag=1;
 SET @end_time =getdate();
print '>>> Data inserted into silver.crm_cust_info';
print'...load duration:' +cast(datediff(second,@end_time,@start_time)as varchar(10) )+' seconds';

print '>>> Inserting Data into silver.crm_prd_info';
SET @start_time =getdate();
Truncate TABLE silver.crm_prd_info;
insert into silver.crm_prd_info(

	 prd_id  ,    
	 cat_id		, 
	 prd_key    ,
	 prd_nm      ,
	 prd_cost   ,
	 prd_line    ,
	 prd_start_dt ,
	 prd_end_dt 

)
select prd_id,
		replace(SUBSTRING(prd_key,1,5),'-','_') cat_id,
		SUBSTRING(prd_key,7,LEN(prd_key)) as prd_key,
	 	prd_nm,
		COALESCE(prd_cost,0) prd_cost,
		CASE UPPER(TRIM(prd_line))
		WHEN 'R' then 'Road'
		when 'M' then 'Mountain'
		when 'T' then 'Touring'
		when 'S' then 'other Sales'
		else
		'unknown'
		end prd_line,
		prd_start_dt,
		dateadd(day, -1 ,lead(prd_start_dt) 
		over(partition by prd_key order by prd_start_dt ) ) as
		prd_end_dt
from bronze.crm_prd_info ;
print '>>> Data inserted into silver.crm_prd_info';
SET @end_time =getdate();
print'...load duration:' +cast(datediff(second,@end_time,@start_time)as varchar(10) )+' seconds';

print '>>>inserting data into silver.sales_details';
SET @start_time =getdate();
TRUNCATE TABLE silver.crm_sales_details;
insert into  silver.crm_sales_details(
	 sls          ,
	 sls_prd_key  ,
	 sls_cust_id  ,
	 sls_order_dt ,
	 sls_ship_dt  ,
	 sls_due_dt  ,
	 sls_sales   ,
	 sls_quantity ,
	 sls_price
	 )


select 
sls,
sls_prd_key,
sls_cust_id,
CASE WHEN sls_order_dt =0 or LEN(sls_order_dt) !=8 then NULL
else CAST(CAST(sls_order_dt as varchar) as DATE)
end sls_order_dt,
CASE WHEN sls_ship_dt =0 or LEN(sls_ship_dt) !=8 then NULL
else CAST(CAST(sls_ship_dt as varchar) as DATE)
end sls_ship_dt,
CASE WHEN sls_due_dt =0 or LEN(sls_due_dt) !=8 then NULL
else CAST(CAST(sls_due_dt as varchar) as DATE)
end sls_due_dt,

CASE WHEN sls_sales IS NULL OR sls_sales<=0 or sls_sales!=sls_quantity*abs(sls_price)
	then sls_quantity*abs(sls_price)
else sls_sales
end sls_sales,
sls_quantity,
case when sls_price<=0 or sls_price is null
	then sls_sales/nullif(sls_quantity,0)
	else sls_price 
end sls_price
from bronze.crm_sales_details;
print '>>> Data inserted into silver.sales_details';
SET @end_time =getdate();
print'...load duration:' +cast(datediff(second,@end_time,@start_time)as varchar(10) )+' seconds';
print '>>> Inserting Data into silver.erp_cust_az12';
SET @start_time =getdate();
TRUNCATE TABLE silver.erp_cust_az12;
insert into silver.erp_cust_az12(

cid,
BDAT,
gen
)
select 
CASE 
when 
CID like 'NAS%'
THEN SUBSTRING(CID,4,len(CID))
else CID
end CID,
case when BDAT> getdate() then NULL
else
BDAT
end BDAT,
case when UPPER(trim(gen))='F'
then 
'Female'
when UPPER(trim(gen))='M' 
then 'Male'
when trim(gen) ='' or gen is null then
'unknown' 
when TRIM(gen)= 'Male' or TRIM(gen)='Female'
then trim(gen)
end gen
from
bronze.erp_cust_az12

print '>>> Inserted Data into silver.erp_cust_az12';
SET @end_time =getdate();
print'...load duration:' +cast(datediff(second,@end_time,@start_time)as varchar(10) )+' seconds';
SET @start_time =getdate();
print '>>> Inserting Data into silver.erp_loc_a101';
TRUnCATE TABLE silver.erp_loc_a101
Insert into silver.erp_loc_a101(
CID,
cntry

)

select replace(CID,'-','') cid, CASE 
when trim(cntry) ='DE' then
'Germany'
when TRIM(cntry) ='USA' or TRIM(cntry) ='US' then
'United States'
when trim(cntry)='' or cntry is null then
'unknown'
else trim(cntry)
end cntry



from bronze.erp_loc_a101;

print '>>> Inserted Data into silver.erp_loc_a101';
SET @end_time =getdate();
print'...load duration:' +cast(datediff(second,@end_time,@start_time)as varchar(10) )+' seconds';
print '>>> Inserting Data into silver.erp_px_cat_g1v2';
SET @start_time =getdate();
TRUNCATE TABLE silver.erp_px_cat_g1v2
insert into silver.erp_px_cat_g1v2(
id,
cat,
subcat,
maintenance



)
select * from bronze.erp_px_cat_g1v2;
print '>>> Inserted Data into silver.erp_px_cat_g1v2';
SET @end_time =getdate();
print'...load duration:' +cast(datediff(second,@end_time,@start_time)as varchar(10) )+' seconds';
END TRY
BEGIN CATCH
select ERROR_MESSAGE() as ErrorMessage
end CATCH;
end
